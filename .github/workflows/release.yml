name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Ubuntu/Debian - dynamically linked
          - name: Ubuntu/Debian (tar.gz)
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: rustipedia-linux-x86_64.tar.gz
            asset_name: rustipedia-linux-x86_64.tar.gz
            build_type: ubuntu
          
          # Debian package
          - name: Debian Package (.deb)
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: rustipedia_amd64.deb
            asset_name: rustipedia_amd64.deb
            build_type: debian
          
          # Linux - statically linked (works on all distros)
          - name: Linux Static (musl)
            os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact_name: rustipedia-linux-x86_64-static.tar.gz
            asset_name: rustipedia-linux-x86_64-static.tar.gz
            build_type: musl
          
          # Fedora/RHEL/CentOS - RPM package
          - name: Fedora/RHEL (.rpm)
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: rustipedia-linux-x86_64.rpm
            asset_name: rustipedia-linux-x86_64.rpm
            build_type: fedora
          
          # Windows
          - name: Windows (.msi)
            os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: rustipedia.msi
            asset_name: rustipedia-windows-x86_64.msi
            build_type: windows
          
          # macOS Intel
          - name: macOS Intel
            os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: rustipedia-macos-x86_64.tar.gz
            asset_name: rustipedia-macos-x86_64.tar.gz
            build_type: macos

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # --- Windows Specific ---
      - name: Install WiX (Windows)
        if: matrix.build_type == 'windows'
        run: cargo install cargo-wix

      - name: Build MSI (Windows)
        if: matrix.build_type == 'windows'
        run: cargo wix --nocapture

      # --- Linux musl (static) ---
      - name: Install musl tools and OpenSSL
        if: matrix.build_type == 'musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev
          rustup target add x86_64-unknown-linux-musl
          
          # Install OpenSSL for musl
          sudo apt-get install -y libssl-dev pkg-config
          
          # Use vendored OpenSSL for musl to avoid cross-compilation issues
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=/usr/include" >> $GITHUB_ENV

      - name: Build static binaries (musl)
        if: matrix.build_type == 'musl'
        env:
          RUSTFLAGS: '-C target-feature=+crt-static'
        run: cargo build --release --target ${{ matrix.target }} --features vendored

      # --- Fedora RPM ---
      - name: Install RPM tools
        if: matrix.build_type == 'fedora'
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Build for Fedora
        if: matrix.build_type == 'fedora'
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create RPM package
        if: matrix.build_type == 'fedora'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild/BUILD/usr/local/bin
          
          cp target/${{ matrix.target }}/release/rustipedia-download rpmbuild/BUILD/usr/local/bin/
          cp target/${{ matrix.target }}/release/rustipedia-serve rpmbuild/BUILD/usr/local/bin/
          cp target/${{ matrix.target }}/release/rustipedia-setup rpmbuild/BUILD/usr/local/bin/
          cp target/${{ matrix.target }}/release/rustipedia-link-validator rpmbuild/BUILD/usr/local/bin/
          
          cat > rpmbuild/SPECS/rustipedia.spec << EOF
          Name:           rustipedia
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        Your Local Wikipedia Server
          License:        MIT
          URL:            https://github.com/ChiefBoyardee/rustipedia
          
          %description
          Rustipedia lets you download and host Wikipedia locally on your computer.
          Browse millions of articles with full-text search, all without an internet connection.
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          cp %{_builddir}/usr/local/bin/* %{buildroot}/usr/local/bin/
          
          %files
          /usr/local/bin/rustipedia-download
          /usr/local/bin/rustipedia-serve
          /usr/local/bin/rustipedia-setup
          /usr/local/bin/rustipedia-link-validator
          
          %changelog
          * $(date "+%a %b %d %Y") GitHub Actions <noreply@github.com> - ${VERSION}-1
          - Automated build from tag ${{ github.ref_name }}
          EOF
          
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/rustipedia.spec
          cp rpmbuild/RPMS/x86_64/*.rpm ${{ matrix.artifact_name }}

      # --- Ubuntu/Debian Build ---
      - name: Build Release (Ubuntu)
        if: matrix.build_type == 'ubuntu'
        run: cargo build --release --target ${{ matrix.target }}

      # --- Debian Package ---
      - name: Build for Debian
        if: matrix.build_type == 'debian'
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create Debian package
        if: matrix.build_type == 'debian'
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          
          mkdir -p debian/usr/local/bin
          mkdir -p debian/DEBIAN
          
          cp target/${{ matrix.target }}/release/rustipedia-download debian/usr/local/bin/
          cp target/${{ matrix.target }}/release/rustipedia-serve debian/usr/local/bin/
          cp target/${{ matrix.target }}/release/rustipedia-setup debian/usr/local/bin/
          cp target/${{ matrix.target }}/release/rustipedia-link-validator debian/usr/local/bin/
          
          cat > debian/DEBIAN/control << EOF
          Package: rustipedia
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: ChiefBoyardee <noreply@github.com>
          Description: Your Local Wikipedia Server
           Download and host Wikipedia locally on your computer.
           Browse millions of articles with full-text search, all without an internet connection.
           .
           This package includes:
            - rustipedia-download: Download Wikipedia dumps
            - rustipedia-serve: Web server for browsing
            - rustipedia-setup: Interactive setup wizard
            - rustipedia-link-validator: Link validation tool
          Homepage: https://github.com/ChiefBoyardee/rustipedia
          EOF
          
          dpkg-deb --build debian ${{ matrix.artifact_name }}

      # --- macOS Build ---
      - name: Build Release (macOS)
        if: matrix.build_type == 'macos'
        run: cargo build --release --target ${{ matrix.target }}

      # --- Package Ubuntu ---
      - name: Package Ubuntu
        if: matrix.build_type == 'ubuntu'
        run: |
          mkdir dist
          cp target/${{ matrix.target }}/release/rustipedia-download dist/
          cp target/${{ matrix.target }}/release/rustipedia-serve dist/
          cp target/${{ matrix.target }}/release/rustipedia-setup dist/
          cp target/${{ matrix.target }}/release/rustipedia-link-validator dist/
          cp install.sh dist/
          cp README.md dist/
          cp LICENSE dist/ || true
          cd dist
          tar -czf ../${{ matrix.artifact_name }} .

      # --- Package musl (static) ---
      - name: Package musl
        if: matrix.build_type == 'musl'
        run: |
          mkdir dist
          cp target/${{ matrix.target }}/release/rustipedia-download dist/
          cp target/${{ matrix.target }}/release/rustipedia-serve dist/
          cp target/${{ matrix.target }}/release/rustipedia-setup dist/
          cp target/${{ matrix.target }}/release/rustipedia-link-validator dist/
          cp install.sh dist/
          cp README.md dist/
          cp LICENSE dist/ || true
          cd dist
          tar -czf ../${{ matrix.artifact_name }} .

      - name: Package macOS
        if: matrix.build_type == 'macos'
        run: |
          mkdir dist
          cp target/${{ matrix.target }}/release/rustipedia-download dist/
          cp target/${{ matrix.target }}/release/rustipedia-serve dist/
          cp target/${{ matrix.target }}/release/rustipedia-setup dist/
          cp target/${{ matrix.target }}/release/rustipedia-link-validator dist/
          cp install_mac.sh dist/
          cp README.md dist/
          cp LICENSE dist/ || true
          cd dist
          tar -czf ../${{ matrix.artifact_name }} .

      # --- Upload Release ---
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ matrix.artifact_name }}
            target/wix/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
